# SDK v10.3 Migration Guide

## Overview

v10.3 introduces GNS staking fee tiers, which work alongside the existing volume-based fee tiers to provide additional fee discounts for users who stake GNS tokens. The total fee multiplier is now the product of both volume-based and staking-based multipliers.

## Breaking Changes

### Changed Types

#### `FeeTiers`

```typescript
// Before (v10.2)
export type FeeTiers = {
  tiers: FeeTier[];
  multipliers: number[];
  currentDay: number;
};

// After (v10.3)
export type FeeTiers = {
  tiers: FeeTier[]; // Volume-based fee tiers
  multipliers: number[];
  currentDay: number;
  stakingTiers: FeeTier[]; // New: GNS staking fee tiers
  gnsVaultAddress?: string; // New: GNS vault address
  useGnsVaultBalance?: boolean; // New: Whether to use vault balance
};
```

#### `TraderFeeTiers`

```typescript
// Before (v10.2)
export type TraderFeeTiers = {
  traderEnrollment: TraderEnrollment;
  traderInfo: TraderInfo;
  inboundPoints: number;
  outboundPoints: number;
  lastDayUpdatedPoints: number;
  expiredPoints: number;
};

// After (v10.3)
export type TraderFeeTiers = {
  traderEnrollment: TraderEnrollment;
  traderInfo: TraderInfo;
  stakingInfo: StakingInfo; // New: GNS staking information
  inboundPoints: number;
  outboundPoints: number;
  lastDayUpdatedPoints: number;
  expiredPoints: number;
};
```

### New Types

#### `StakingInfo`

```typescript
export type StakingInfo = {
  stakedGns: number; // Amount of GNS staked
  stakedVaultGns: number; // Amount of gGNS staked
  bonusAmount: number; // Bonus amount (0 precision)
  stakeTimestamp: number; // Unix timestamp of last stake action
  feeMultiplierCache: number; // Cached fee multiplier from staking (1e3 precision)
};
```

### Changed Function Signatures

#### `convertFeeTiersConfig`

```typescript
// Before (v10.2)
convertFeeTiersConfig(
  tiers: IFeeTiers.FeeTierStructOutput[],
  groupVolumeMultipliers: readonly bigint[],
  currentDay: bigint
): {
  tiers: FeeTier[];
  groupVolumeMultipliers: number[];
  currentDay: number;
}

// After (v10.3)
convertFeeTiersConfig(
  tiers: IFeeTiers.FeeTierStructOutput[],
  groupVolumeMultipliers: readonly bigint[],
  currentDay: bigint,
  stakingTiers: IFeeTiers.FeeTierStructOutput[] // New parameter
): {
  tiers: FeeTier[];
  groupVolumeMultipliers: number[];
  currentDay: number;
  stakingTiers: FeeTier[]; // New field
}
```

#### `convertTraderFeeTiersData`

```typescript
// Before (v10.2)
convertTraderFeeTiersData(
  traderInfo: IFeeTiers.TraderInfoStructOutput,
  traderDailyInfo: readonly bigint[],
  traderEnrollment: IFeeTiers.TraderEnrollmentStructOutput
): {
  traderInfo: TraderInfo;
  dailyPoints: number[];
  traderEnrollment: TraderEnrollment;
}

// After (v10.3)
convertTraderFeeTiersData(
  traderInfo: IFeeTiers.TraderInfoStructOutput,
  traderDailyInfo: readonly bigint[],
  traderEnrollment: IFeeTiers.TraderEnrollmentStructOutput,
  stakingInfo: IFeeTiers.GnsStakingInfoStructOutput // New parameter
): {
  traderInfo: TraderInfo;
  dailyPoints: number[];
  traderEnrollment: TraderEnrollment;
  stakingInfo: StakingInfo; // New field
}
```

#### `computeFeeMultiplier`

```typescript
// Before (v10.2)
computeFeeMultiplier(
  feeTiers: FeeTiers,
  traderFeeTiers: TraderFeeTiers
): {
  feeMultiplier: number;
  trailingPoints: number;
}

// After (v10.3)
computeFeeMultiplier(
  feeTiers: FeeTiers,
  traderFeeTiers: TraderFeeTiers
): {
  feeMultiplier: number; // Updated: Product of volume and staking multipliers
  volumeFeeMultiplier: number; // New: Multiplier from volume tiers, previously `feeMultiplier`
  trailingPoints: number;
  stakingFeeMultiplier: number; // New: Multiplier from staking tiers
}
```

## New Features

### GNS Staking Fee Tiers

The SDK now supports GNS staking fee tiers that provide additional fee discounts based on the amount of GNS tokens a trader has staked:

- **Volume-based tiers**: Original fee tiers, provide discounts based on trading volume (trailing points)
- **Staking-based tiers**: Provide discounts based on GNS staking amount
- **Combined multiplier**: `totalFeeMultiplier = volumeFeeMultiplier * stakingFeeMultiplier`

### Staking Cooldown Period

When a trader stakes or unstakes GNS, there is a 1-day cooldown period:

```typescript
import { isGnsStakingCooldownActive, GNS_STAKING_COOLDOWN_SECONDS } from "@gainsnetwork/sdk/trade/fees/tiers";

const { isActive, expiryTs } = isGnsStakingCooldownActive(traderFeeTiers);

if (isActive) {
  console.log(`Cooldown active until ${new Date(expiryTs * 1000)}`);
}
```

### New Converter Function

```typescript
// Convert contract GNS staking info to SDK format
convertStakingInfo(
  contractData: IFeeTiers.GnsStakingInfoStructOutput
): StakingInfo
```

## Fee Multiplier Calculation Changes

### Understanding the New Fee Multiplier

In v10.3, the fee multiplier calculation now includes both volume and staking components:

```typescript
import { computeFeeMultiplier } from "@gainsnetwork/sdk/trade/fees/tiers";

const result = computeFeeMultiplier(feeTiers, traderFeeTiers);

// v10.3 returns:
{
  feeMultiplier: 0.8,           // Total: 0.9 * 0.89 â‰ˆ 0.8
  volumeFeeMultiplier: 0.9,     // Multiplier from volume tiers
  trailingPoints: 150000,       // Trailing points from volume
  stakingFeeMultiplier: 0.89,   // Multiplier from staking tiers
}

// Previously returned only:
{
  feeMultiplier: 0.9,           // Only volume-based
  trailingPoints: 150000,
}
```

### Fee Multiplier Behavior

1. **Excluded traders**: Always get `1.0` for both multipliers (no discount)
2. **No staking**: If `stakingInfo.feeMultiplierCache === 0`, staking multiplier defaults to `1.0`
3. **Volume tiers**: Based on trailing points across 30 days
4. **Staking tiers**: Based on cached multiplier from contract (updated on stake/unstake)

## Migration Steps

### 1. Update Type Definitions

```typescript
// If you're storing fee tiers configuration
interface MyAppState {
  // Before
  feeTiers: {
    tiers: FeeTier[];
    multipliers: number[];
    currentDay: number;
  };

  // After
  feeTiers: {
    tiers: FeeTier[];
    multipliers: number[];
    currentDay: number;
    // New:
    stakingTiers: FeeTier[]; // Add staking tiers
    gnsVaultAddress?: string; // Optional
    useGnsVaultBalance?: boolean; // Optional
  };
}
```

### 2. Update Fee Multiplier Usage

```typescript
// Before (v10.2)
const { feeMultiplier, trailingPoints } = computeFeeMultiplier(
  feeTiers,
  traderFeeTiers
);
const feeAmount = positionSizeUsd * baseFeeRate * feeMultiplier;

// After (v10.3) - Basic usage (same as before)
const { feeMultiplier, trailingPoints } = computeFeeMultiplier(
  feeTiers,
  traderFeeTiers
);
const feeAmount = positionSizeUsd * baseFeeRate * feeMultiplier;

// After (v10.3) - With detailed breakdown
const {
  feeMultiplier,
  volumeFeeMultiplier,
  stakingFeeMultiplier,
  trailingPoints,
} = computeFeeMultiplier(feeTiers, traderFeeTiers);

// Can now show users breakdown:
console.log(`Volume discount: ${(1 - volumeFeeMultiplier) * 100}%`);
console.log(`Staking discount: ${(1 - stakingFeeMultiplier) * 100}%`);
console.log(`Total discount: ${(1 - feeMultiplier) * 100}%`);
```

### 3. Handle Staking Information

```typescript
// Access trader's staking information
const { stakingInfo } = traderFeeTiers;

console.log(`Staked GNS: ${stakingInfo.stakedGns}`);
console.log(`Staked gGNS: ${stakingInfo.stakedVaultGns}`);
console.log(`Staking multiplier: ${stakingInfo.feeMultiplierCache}`);

// Check if cooldown is active
const { isActive, expiryTs } = isGnsStakingCooldownActive(traderFeeTiers);
if (isActive) {
  const remainingSeconds = expiryTs - Math.floor(Date.now() / 1000);
  console.log(`Cooldown: ${remainingSeconds}s remaining`);
}
```

### 4. Update Contract Interactions

Fetching fee tiers from the contract:

```typescript
// Fetch all fee tiers (use new getter to fetch all active fee tiers)
const volumeFeeTiers = await diamond.getFeeTiers(); // New: returns all active fee tiers
// Fetch all staking tiers
const stakingFeeTiers = await diamond.getGnsStakingTiers();

```

Fetching staking info for a trader:

```typescript
const stakingInfo = await diamond.getGnsStakingInfo(traderAddress);
```

### 5. Backend Integration

The backend now provides staking-related data in trading variables:

```typescript
interface TradingVariablesBackend {
  // ...
  feeTiers: {
    tiers: FeeTierBackend[]; // Volume fee tiers
    multipliers: string[];
    currentDay: number;
    // New:
    stakingTiers: FeeTierBackend[]; // Staking fee tiers
    gnsVaultAddress: string; // GNS vault address
    useGnsVaultBalance: boolean; // Use vault balance flag
  };
  // ...
}

interface TraderFeeTiersBackend {
  traderEnrollment: TraderEnrollmentBackend;
  traderInfo: TraderInfoBackend;
  stakingInfo: StakingInfoBackend; // New: Staking info
  // ...
}
```

The converter functions automatically handle the new fields:

```typescript
import { convertFeeTiers, convertTraderFeeTiers } from "@gainsnetwork/sdk/backend/tradingVariables/converter";

// Automatically includes stakingTiers, gnsVaultAddress, useGnsVaultBalance
const feeTiers = convertFeeTiers(backendFeeTiers);

// Automatically includes stakingInfo
const traderFeeTiers = convertTraderFeeTiers(backendTraderFeeTiers);
```

## Constants

### New Constants

```typescript
import { GNS_STAKING_COOLDOWN_SECONDS } from "@gainsnetwork/sdk/trade/fees/tiers";

// Cooldown period after staking/unstaking
console.log(GNS_STAKING_COOLDOWN_SECONDS); // 86400 (1 day)
```

## Complete Example

```typescript
import {
  computeFeeMultiplier,
  isGnsStakingCooldownActive,
  GNS_STAKING_COOLDOWN_SECONDS,
} from "@gainsnetwork/sdk/trade/fees/tiers";
import type { FeeTiers, TraderFeeTiers } from "@gainsnetwork/sdk/trade/types";

// ...

// Compute fee multiplier (now includes staking)
const {
  feeMultiplier, // total multiplier (volume * staking)
  volumeFeeMultiplier, // multiplier from volume tiers
  stakingFeeMultiplier, // multiplier from staking tiers
  trailingPoints, // trailing points from volume tiers
} = computeFeeMultiplier(feeTiers, traderFeeTiers);

// Check staking cooldown
const { isActive, expiryTs } = isGnsStakingCooldownActive(traderFeeTiers);

// Display to user
console.log("Fee Discount Breakdown:");
console.log(`  Volume discount: ${((1 - volumeFeeMultiplier) * 100).toFixed(2)}%`);
console.log(`  Staking discount: ${((1 - stakingFeeMultiplier) * 100).toFixed(2)}%`);
console.log(`  Total discount: ${((1 - feeMultiplier) * 100).toFixed(2)}%`);
console.log(`  Total fee multiplier: ${feeMultiplier.toFixed(3)}`);
console.log();
console.log("Staking Info:");
console.log(`  Staked GNS: ${traderFeeTiers.stakingInfo.stakedGns.toFixed(2)}`);
console.log(`  Vault GNS: ${traderFeeTiers.stakingInfo.stakedVaultGns.toFixed(2)}`);
if (isActive) {
  console.log(`  Cooldown active until: ${new Date(expiryTs * 1000).toISOString()}`);
}

// Calculate fee
const baseFeeRate = 0.006; // using 0.06% as example
const positionSizeUsd = 10000;
const feeAmount = positionSizeUsd * baseFeeRate * feeMultiplier;
console.log(`Fee amount: $${feeAmount.toFixed(2)}`);
```

## Summary

v10.3 introduces a powerful new fee discount system based on GNS staking that works alongside the existing volume-based tiers. The changes are mostly backward compatible - existing code using `computeFeeMultiplier` will continue to work, but you can now access detailed breakdowns of volume and staking multipliers separately.
