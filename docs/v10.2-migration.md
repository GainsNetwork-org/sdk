# SDK v10.2 Migration Guide

## Overview

Version 10.2 introduces a new 30-band depth system for price impact calculations, replacing the previous single `onePercentDepthUsd` value. This provides more granular control over liquidity depth at different price levels.

## Breaking Changes

### Removed Types and Functions

The following exports have been removed from `src/trade/priceImpact/cumulVol`:

- `PairDepth` type (no longer used anywhere)
- `convertPairDepths()` function
- Legacy 1% depth fallback - returns 0 when no depth bands available

### Changed Function Signatures

#### `getSpreadWithCumulVolPriceImpactP`

The `pairDepth` parameter has been removed:

```typescript
// Before (v10.1)
getSpreadWithCumulVolPriceImpactP(
  pairSpreadP: number,
  buy: boolean,
  collateral: number,
  leverage: number,
  pairDepth: PairDepth | undefined, // REMOVED
  oiWindowsSettings?: OiWindowsSettings,
  oiWindows?: OiWindows,
  context?: CumulVolContext
): number

// After (v10.2)
getSpreadWithCumulVolPriceImpactP(
  pairSpreadP: number,
  buy: boolean,
  collateral: number,
  leverage: number,
  oiWindowsSettings?: OiWindowsSettings,
  oiWindows?: OiWindows,
  context?: CumulVolContext
): number
```

### Changed Types

#### `PairDepthBands` (formerly `PairDepth`)

```typescript
// Before (v10.1)
export interface PairDepth {
  aboveUsd: number;
  belowUsd: number;
}

// After (v10.2)
export interface PairDepthBands {
  above: DepthBands;
  below: DepthBands;
}

export interface DepthBands {
  totalDepthUsd: number;
  bands: number[]; // 30 values, each 0-1 representing percentage of total depth
}
```

#### `DepthBandsMapping` (new)

```typescript
export interface DepthBandsMapping {
  bands: number[]; // 30 values in basis points (0-10000)
}
```

## Price Impact Calculation Changes

### Updated Context Type

The `CumulVolContext` type now includes depth bands data:

```typescript
// Added fields in CumulVolContext
export type CumulVolContext = {
  // ... existing fields ...

  // Depth bands data (v10.2+)
  pairDepthBands?: PairDepthBands | undefined;
  depthBandsMapping?: DepthBandsMapping | undefined;

  // ... other fields ...
};
```

### Updated `getTradeCumulVolPriceImpactP` Function

The main price impact calculation function now automatically uses depth bands when available:

```typescript
// Function signature remains the same
getTradeCumulVolPriceImpactP(
  trader: string,
  pairIndex: number,
  long: boolean,
  tradeOpenInterestUsd: number,
  isPnlPositive: boolean,
  open: boolean,
  lastPosIncreaseBlock: number,
  context: CumulVolContext
): number

// But now the context should include depth bands data
const priceImpact = getTradeCumulVolPriceImpactP(
  trader,
  pairIndex,
  isLong,
  positionSizeUsd,
  isPnlPositive,
  isOpen,
  lastPosIncreaseBlock,
  {
    ...existingContext,
    pairDepthBands: depthBands,      // New: Include depth bands
    depthBandsMapping: depthMapping, // New: Include global mapping
  }
);
```

The function will:

1. Use depth bands if `pairDepthBands` and `depthBandsMapping` are provided
2. Return 0 if depth bands are not available or total depth is 0
3. Apply the 30-band system internally for accurate price impact calculation

### Other Affected Functions

Functions that use `CumulVolContext` now support depth bands:

- `getSpreadWithCumulVolPriceImpactP` - Automatically uses depth bands from context (pairDepth parameter removed)
- `getCumulVolPriceImpact` - Convenience function that also supports depth bands
- `getSpreadWithPriceImpactP` - Legacy alias, also has pairDepth parameter removed

## Migration Steps

### 1. Update Import Statements

```typescript
// Before
import {
  PairDepth,
  convertPairDepths,
} from "@gainsnetwork/sdk/trade/priceImpact/cumulVol";

// After
import {
  PairDepthBands,
  DepthBands,
  DepthBandsMapping,
} from "@gainsnetwork/sdk/trade/priceImpact/cumulVol";
```

### 2. Update Data Access Patterns

#### Accessing Depth Data

```typescript
// Before
const aboveDepth = pairDepth.aboveUsd;
const belowDepth = pairDepth.belowUsd;

// After
const aboveTotalDepth = pairDepthBands.above.totalDepthUsd;
const belowTotalDepth = pairDepthBands.below.totalDepthUsd;
const aboveBands = pairDepthBands.above.bands; // Array of 30 percentages
const belowBands = pairDepthBands.below.bands; // Array of 30 percentages
```

#### Working with Global Trading Variables

```typescript
// Before
const depths = globalTradingVariables.pairDepths;

// After
const depthBands = globalTradingVariables.pairDepthBands; // Per-pair depth bands
const depthMapping = globalTradingVariables.depthBandsMapping; // Global band definitions
```

### 3. Update Contract Interactions

If you're directly interacting with contracts:

```typescript
// Before - Fetching depth values
const pairDepths = await diamond.getPairDepths(pairIndices);

// After - Fetching depth bands (note: overloaded functions require quoted signatures for arrays)
// Single pair (no quotes needed)
const singlePairBands = await diamond.getPairDepthBands(pairIndex);

// Multiple pairs (quotes required for overloaded array version)
const pairDepthBands = await diamond["getPairDepthBands(uint256[])"](
  pairIndices
);
const depthBandsMapping = await diamond.getDepthBandsMapping();

// For decoded values (also overloaded)
// Single pair
const decodedSingle = await diamond.getPairDepthBandsDecoded(pairIndex);

// Multiple pairs (quotes required)
const decodedMultiple = await diamond["getPairDepthBandsDecoded(uint256[])"](
  pairIndices
);
const decodedMapping = await diamond.getDepthBandsMappingDecoded();
```

### 3a. Update SDK Utility Functions

If you're using SDK utility functions:

```typescript
// Before
import { fetchPairDepths } from "@gainsnetwork/sdk/contracts/utils/pairs";
const depths = await fetchPairDepths(contracts, pairIndices);

// After - New functions available
import {
  fetchPairDepthBands,
  fetchPairDepthBandsDecoded,
  fetchDepthBandsMapping,
  fetchDepthBandsMappingDecoded,
} from "@gainsnetwork/sdk/contracts/utils/pairs";

// Fetch encoded depth bands
const depthBands = await fetchPairDepthBands(contracts, pairIndices);

// Fetch decoded depth bands (recommended for easier use)
const decoded = await fetchPairDepthBandsDecoded(contracts, pairIndices);
// Returns: { totalDepthAboveUsd, totalDepthBelowUsd, bandsAbove, bandsBelow }

// Fetch global mapping
const mapping = await fetchDepthBandsMapping(contracts);
const decodedMapping = await fetchDepthBandsMappingDecoded(contracts);
```

### 4. Backend Integration

The backend now provides depth bands data in the trading variables:

```typescript
interface TradingVariablesBackend {
  // ...
  pairInfos: {
    pairDepthBands: PairDepthBandsBackend[]; // Replaces pairDepths
    // ...
  };
  depthBandsMapping: DepthBandsMappingBackend; // New global mapping
  // ...
}
```

## Conversion Functions

### New Converter Functions

```typescript
// Convert from contract slots to SDK format
convertPairDepthBandsFromSlots(
  aboveSlot1: bigint,
  aboveSlot2: bigint,
  belowSlot1: bigint,
  belowSlot2: bigint
): PairDepthBands

// Convert from decoded contract values
convertDepthBands(
  totalDepthUsd: number,
  bandsBps: number[] // Basis points (10000 = 100%)
): DepthBands

// Convert global mapping
convertDepthBandsMapping(
  bandsBps: number[] // Basis points
): DepthBandsMapping
```

### Backend Type Converters

```typescript
// Convert backend response to SDK format
convertPairDepthBands(
  pairDepthBands: PairDepthBandsBackend[]
): PairDepthBands[]

convertDepthBandsMapping(
  mapping: DepthBandsMappingBackend
): DepthBandsMapping
```
